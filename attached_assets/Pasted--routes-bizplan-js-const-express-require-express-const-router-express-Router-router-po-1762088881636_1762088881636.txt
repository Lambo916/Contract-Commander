// routes/bizplan.js
const express = require('express');
const router = express.Router();

router.post('/bizplan', express.json(), async (req, res) => {
  try {
    const {
      companyName,
      industry,
      targetCustomer,
      offer,
      revenueModel,
      stage,
      goals,
      tone
    } = req.body || {};

    if (!companyName || !industry) {
      return res.status(400).json({ error: 'companyName and industry are required.' });
    }

    // Use OpenAI via env var (no managed integration required)
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) return res.status(500).json({ error: 'OPENAI_API_KEY missing.' });

    // Minimal SDK-less fetch version (works on Node 18+)
    const prompt = `
You are BizPlan Builder. Draft a concise, investor-ready business plan as markdown.
Company: ${companyName}
Industry: ${industry}
Target Customer: ${targetCustomer || 'N/A'}
Offer (product/service): ${offer || 'N/A'}
Revenue Model: ${revenueModel || 'N/A'}
Stage: ${stage || 'N/A'}
Top Goals (next 6 months): ${goals || 'N/A'}
Tone: ${tone || 'professional'}

Include sections: Executive Summary, Problem, Solution, Market, Business Model, Go-to-Market, Operations, Team (placeholder), Financial Outline (assumptions + 12-mo milestones), Risks & Mitigations, Next Steps.
Keep it 900â€“1400 words, crisp, and skimmable with headings and bullet points.
    `.trim();

    const r = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: 'You generate clear, actionable business plans.' },
          { role: 'user', content: prompt }
        ],
        temperature: 0.6
      })
    });

    const data = await r.json();
    if (!r.ok) return res.status(500).json({ error: data.error?.message || 'OpenAI error' });

    const content = data.choices?.[0]?.message?.content || '';
    return res.json({ content });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: 'Server error' });
  }
});

module.exports = router;