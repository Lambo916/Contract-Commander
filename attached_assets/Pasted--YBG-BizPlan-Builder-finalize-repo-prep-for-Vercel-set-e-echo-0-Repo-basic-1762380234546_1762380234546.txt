# === YBG :: BizPlan Builder — finalize repo + prep for Vercel ===
set -e

echo "➡️  0) Repo + basic info"
NEW_ORIGIN="https://github.com/Lambo916/BizPlan-Builder.git"
PROJECT_NAME="biz-plan-builder"

# 1) Confirm Git is initialized and point remote to the new repo
echo "➡️  1) Set Git remote to BizPlan-Builder"
git init
if git remote | grep -q "^origin$"; then
  git remote remove origin
fi
git remote add origin "$NEW_ORIGIN"
git remote -v

# 2) Snapshot: ensure working tree is committed
echo "➡️  2) Commit any pending changes (if any)"
git add -A
if ! git diff --cached --quiet; then
  git commit -m "Finalize BizPlan Builder rebrand + env prep"
fi

# 3) Pull env values from Replit Secrets (no printing)
echo "➡️  3) Read env (from Replit Secrets) safely"
# These may or may not exist depending on the original template; we just read if present
read_env() { printenv "$1" >/dev/null 2>&1 && echo "$(printenv "$1")" || true; }

OPENAI_API_KEY_VAL="$(read_env OPENAI_API_KEY)"
DATABASE_URL_VAL="$(read_env DATABASE_URL)"
SUPABASE_URL_VAL="$(read_env SUPABASE_URL)"
SUPABASE_ANON_KEY_VAL="$(read_env SUPABASE_ANON_KEY)"
PUBLIC_SITE_URL_VAL="$(read_env PUBLIC_SITE_URL)"
CORS_ALLOWED_ORIGINS_VAL="$(read_env CORS_ALLOWED_ORIGINS)"
TOOL_NAME_VAL="$(read_env TOOL_NAME)"
SESSION_SECRET_VAL="$(read_env SESSION_SECRET)"
REPORT_CAP_VAL="$(read_env REPORT_CAP)"
RATE_LIMIT_WINDOW_VAL="$(read_env RATE_LIMIT_WINDOW)"
PGHOST_VAL="$(read_env PGHOST)"
PGPORT_VAL="$(read_env PGPORT)"
PGUSER_VAL="$(read_env PGUSER)"
PGPASSWORD_VAL="$(read_env PGPASSWORD)"
PGDATABASE_VAL="$(read_env PGDATABASE)"

# 4) Create/refresh .env.example (placeholders only; NEVER actual secrets)
echo "➡️  4) Write sanitized .env.example"
cat > .env.example <<'ENVX'
# === BizPlan Builder (.env.example) ===
# Fill these in your hosting dashboard (Replit Secrets / Vercel Env).
OPENAI_API_KEY=sk-***
DATABASE_URL=postgresql://user:pass@host:5432/dbname?sslmode=require

# Supabase (client-safe keys live in the browser; anon key is intentionally public)
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# App
PUBLIC_SITE_URL=https://bizplan.yourbizguru.com
CORS_ALLOWED_ORIGINS=https://bizplan.yourbizguru.com,https://*.vercel.app
TOOL_NAME=Bizplanbuilder
SESSION_SECRET=change-me

# Optional limits
REPORT_CAP=30
RATE_LIMIT_WINDOW=86400

# Optional Postgres pieces (if your stack references discrete vars)
PGHOST=your-host
PGPORT=5432
PGUSER=your-user
PGPASSWORD=your-password
PGDATABASE=your-db
ENVX

# 5) Minimal vercel.json (safe defaults; can be overridden in Dashboard)
echo "➡️  5) Write vercel.json (generic Node/SPA defaults)"
cat > vercel.json <<'VJSON'
{
  "version": 2,
  "builds": [
    { "src": "package.json", "use": "@vercel/node" }
  ],
  "routes": [
    { "src": "/api/(.*)", "dest": "/api/$1" },
    { "src": "/(.*)", "dest": "/" }
  ]
}
VJSON

# 6) README patch (keeps your nice repo landing clean)
echo "➡️  6) Ensure README mentions live URL + deploy steps"
if ! grep -qi "YourBizGuru" README.md 2>/dev/null; then
  cat > README.md <<'MDX'
# BizPlan-Builder

YourBizGuru Business Planning Toolkit — create professional investor-ready business plans with AI-powered insights, KPI tracking, and export-ready PDF reports.

## Live
- Production: https://bizplan.yourbizguru.com
- Preview (Vercel): https://biz-plan-builder.vercel.app

## Environment
Copy `.env.example` to your env system (Replit Secrets / Vercel Env). Do **not** commit secrets.

## Deploy (Vercel)
1) Import this repo in Vercel.
2) Add env vars (match `.env.example`).
3) Set Domain: `bizplan.yourbizguru.com`.
4) Deploy.
MDX
fi

# 7) Commit the scaffolding we just added
echo "➡️  7) Commit env example + vercel.json + README (no secrets)"
git add .env.example vercel.json README.md 2>/dev/null || true
if ! git diff --cached --quiet; then
  git commit -m "Docs: add .env.example, vercel.json, README updates"
fi

# 8) Push to GitHub (main)
echo "➡️  8) Push to GitHub main"
git branch -M main
git push -u origin main

echo "✅ Done. Repo is clean and ready to import on Vercel."
echo "Next: In Vercel → New Project → Import this repo → Add env vars → Set domain bizplan.yourbizguru.com → Deploy."